<!DOCTYPE html>
<html>
    <head>
	<title>Twitch Community Games Bot</title>
	<script src="tmi.min.js"></script>
	<script src="conf.js"></script>

	<script>

let client;
function connect_to_channel() {
    username_input = document.getElementById('username');
    password_input = document.getElementById('password');
    username = username_input.value;
    password = password_input.value;

    client = new tmi.Client({
	options: {debug: false, messagesLogLevel: "info" },
	connection: {reconnect: true, secure: true},
	identity: {
	    username: username,
	    password: password
	},
	channels: conf.channels
    });
    client.connect().catch(console.error);
    client.on('chat', on_chat);
    client.on('action', on_action);
    client.on('whipser', on_whisper);
}

window.addEventListener('load', function(){
    username_input = document.getElementById('username');
    password_input = document.getElementById('password');
    username_input.value=conf.username;
    password_input.value=conf.password;
});

function on_chat(channel, userstate, message, self){
    //'nightbot', '19264788'
    //'streamelements', ''
    aoe2de_pattern = new RegExp('aoe2de:\/\/\\d\/\\d+');
    message_pattern = new RegExp('^([a-zA-Z0-9_]+) has won the giveaway.$');

    // find messages that match the give away, extract username
    //console.log(userstate, message);

    // message comes from nightbot?
    // if userstate['user-id'] ==
    if(userstate['username'] == 'nightbot') {
	match = message.match(message_pattern);
	if(match !== null){
	    username = match[1];
	    console.log(username+' WON!!!');
	    add_username_to_list(username);
	}
    }
    if(userstate['username'] == 'streamelements') {
    }
}
function on_action(channel, userstate, message, self){
    // respond to action commands
}
function on_whisper(channel, userstate, message, self){
    // relay whispers to other winners of give away
}

function add_username_to_list(username){
    usernames_list_div = document.getElementById('usernames_list');
    new_username_div = document.createElement('div');
    new_username_div.className = 'username_entry';
    username_text_node = document.createTextNode(username);
    new_username_div.append(username_text_node);
    usernames_list_div.appendChild(new_username_div);
}

function clear_usernames(){
    usernames_list_div = document.getElementById('usernames_list');
    
    usernames_list = Array.from(usernames_list_div.childNodes);
    usernames_list.forEach((child_node, index)=>{
	usernames_list_div.removeChild(child_node);
    });
}

	</script>
    </head>
    <body>
	<h2> Config </h2>
	<label for='username'>username:</label>
	<input type='text' id='username' name='username'><br>
	<label for='password'>password:</label>
	<input type='text' id='password' name='password'><br>
	<button type='button' onclick='connect_to_channel()'>Connect</button><br>
	<button type='button' onclick='client.disconnect()'>Disconnect</button><br>
	<h2>Whisper to</h2>
	<div style='border:1px black solid; width:300px; height:100px; overflow:auto; float:left; padding-left:4px; margin:5px;' contenteditable='true'></div>

	<div id='usernames_list' style='border:1px black solid; width:300px; height:100px; overflow:auto; float:left; padding:4px; margin:5px;'>
	</div>

	<div>
	<button type='button' onclick='clear_usernames()'>Clear list</button><br>
	<button type='button'>Whisper all</button><br>
	</div>

	<h2>Whispers</h2>
	<div style='border:1px black solid; width:200px; height:300px; overflow:auto; float:left; padding-left: 4px; margin:5px'>
	    <p><b>User: </b>Text of the whisper.</p>
	    <p>Next line.</p>
	</div>
	<div style='border:1px black solid; width:200px; height:300px; overflow:auto; float:left; padding-left: 4px; margin:5px'>
	    Another box of text.
	</div>
	<div style='border:1px black solid; width:200px; height:300px; overflow:auto; float:left; padding-left: 4px; margin:5px'>
	    Another box of text.
	</div>
	<div style='border:1px black solid; width:200px; height:300px; overflow:auto; float:left; padding-left: 4px; margin:5px'>
	    Another box of text.
	</div>
	<div style='border:1px black solid; width:200px; height:300px; overflow:auto; float:left; padding-left: 4px; margin:5px'>
	    Another box of text.
	</div>
	
    </body>
</html> 
